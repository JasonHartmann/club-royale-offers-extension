name: Package Chrome Extension

on:
  push:
    branches: [ main ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run unit tests
        run: npm test

      - name: Upload extension files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: club-royale-offers-extension
          path: |
            **/*.js
            **/*.png
            **/*.ico
            **/*.svg
            **/*.css
            manifest.json
            !**/node_modules/**
            !scripts/**
            !**/scripts/**
            !tests/**
            !**/tests/**
            !jest.config.js
            !**/jest.config.js

  safari-package:
    runs-on: macos-latest
    steps:
      - name: Checkout extension repository
        uses: actions/checkout@v4

      - name: Checkout Safari Xcode repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.SAFARI_XCODE_REPO }}
          ref: ${{ vars.SAFARI_XCODE_REF || 'main' }}
          path: ClubRoyaleSafari
          token: ${{ secrets.SAFARI_XCODE_TOKEN }}

      - name: Resolve Xcode project path (if missing)
        if: ${{ vars.SAFARI_XCODE_PROJECT_PATH == '' }}
        run: |
          PROJECT_PATH=$(find "$GITHUB_WORKSPACE/ClubRoyaleSafari" -name "*.xcodeproj" -maxdepth 6 -print -quit)
          if [ -z "$PROJECT_PATH" ]; then
            echo "No .xcodeproj found under ClubRoyaleSafari" >&2
            exit 1
          fi
          echo "XCODE_PROJECT_PATH=$PROJECT_PATH" >> "$GITHUB_ENV"

      - name: Install extension dependencies
        run: npm ci

      - name: Build Safari bundles
        run: ./scripts/build-safari-xcode.sh
        env:
          XCODE_PROJECT_PATH: ${{ vars.SAFARI_XCODE_PROJECT_PATH || env.XCODE_PROJECT_PATH }}

      - name: Upload Safari artifacts
        uses: actions/upload-artifact@v4
        with:
          name: club-royale-offers-safari
          path: safari-build/artifacts/*.zip
